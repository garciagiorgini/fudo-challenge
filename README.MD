# Fudo Backend Challenge (Rack + Ruby)

Este proyecto implementa una API en Ruby puro usando Rack (sin Rails) como base. Cumple con los requerimientos del challenge de Fudo.

---

## ğŸ§± Requisitos

- Ubuntu Linux
- Ruby â‰¥ 3.2
- Bundler (instalado localmente)
- Docker y Docker Compose
- `rack` y `webrick` como gems

---

## ğŸ”§ InstalaciÃ³n paso a paso en Ubuntu

### 1. Instalar Ruby y dependencias de compilaciÃ³n

```bash
sudo apt update
sudo apt install ruby-full build-essential
```

### 2. Instalar Bundler localmente (sin sudo)

```bash
gem install --user-install bundler
```

AgregÃ¡ Bundler al PATH en tu ~/.bashrc (ajustÃ¡ si usÃ¡s otra shell):

```bash
echo 'export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

ReemplazÃ¡ 3.2.0 con la versiÃ³n de Ruby que tengas (ruby -v).

### 3. ConfiguraciÃ³n del entorno con Bundler

ConfigurÃ¡ Bundler para usar un directorio local:

```bash
bundle config set path 'vendor/bundle'
```

InstalÃ¡ las dependencias del proyecto:

```bash
bundle install
```

## ğŸš€ CÃ³mo ejecutar la app

### OpciÃ³n 1: Localmente

Una vez instaladas las dependencias, levantÃ¡ la app con:

```bash
bundle exec rackup
```

La app estarÃ¡ corriendo en:

http://localhost:9292

### OpciÃ³n 2: Con Docker

#### Desarrollo (con hot-reload)

1. Crear archivo `.env` con las variables de entorno:
```bash
JWT_SECRET_KEY=tu_clave_secreta_aqui
JWT_TOKEN_EXPIRATION=3600
JWT_REFRESH_TOKEN_EXPIRATION=604800
JWT_MAX_SESSION_DURATION=2592000
```

2. Iniciar con Docker Compose:
```bash
docker compose up
```

#### ProducciÃ³n

1. Construir la imagen:
```bash
docker build -t ruby-challenge .
```

2. Ejecutar el contenedor:
```bash
docker run -p 9292:9292 ruby-challenge
```

## ğŸ“ Estructura de archivos

```
.
â”œâ”€â”€ app.rb              # App principal (Rack)
â”œâ”€â”€ config.ru           # Entrada para rackup
â”œâ”€â”€ router.rb           # Router HTTP con Sinatra
â”œâ”€â”€ product_store.rb    # LÃ³gica de productos
â”œâ”€â”€ auth.rb            # LÃ³gica de autenticaciÃ³n
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ jwt_service.rb # Servicio JWT
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth_middleware.rb # Middleware de autenticaciÃ³n
â”‚   â””â”€â”€ gzip.rb           # Middleware de compresiÃ³n
â”œâ”€â”€ config.rb          # ConfiguraciÃ³n de la app
â”œâ”€â”€ openapi.yaml       # EspecificaciÃ³n OpenAPI de la API
â”œâ”€â”€ Gemfile            # Dependencias
â”œâ”€â”€ docker-compose.yml # ConfiguraciÃ³n de Docker para desarrollo
â””â”€â”€ README.md
```

## ğŸ” Sistema de AutenticaciÃ³n

La API implementa un sistema de autenticaciÃ³n JWT con refresh tokens:

### Tokens y Tiempos de ExpiraciÃ³n

- **Access Token**: Expira despuÃ©s de 1 hora (3600 segundos)
- **Refresh Token**: Expira despuÃ©s de 7 dÃ­as (604800 segundos)
- **SesiÃ³n MÃ¡xima**: Expira despuÃ©s de 30 dÃ­as (2592000 segundos)

### Flujo de AutenticaciÃ³n

1. **Registro de usuario**:
```bash
curl -X POST http://localhost:9292/register \
  -H 'Content-Type: application/json' \
  -d '{"user":"admin", "password":"1234"}'
```

2. **AutenticaciÃ³n**:
```bash
curl -X POST http://localhost:9292/auth \
  -H 'Content-Type: application/json' \
  -d '{"user":"admin", "password":"1234"}'
```
Respuesta:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiJ9...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

3. **Refresh Token**:
```bash
curl -X POST http://localhost:9292/refresh \
  -H 'Content-Type: application/json' \
  -d '{"refresh_token":"tu_refresh_token"}'
```

### CaracterÃ­sticas de Seguridad

- Los tokens incluyen un identificador Ãºnico (JTI)
- El refresh token mantiene el tiempo de inicio de sesiÃ³n original
- La sesiÃ³n expira despuÃ©s de 30 dÃ­as, independientemente de los refreshes
- Los tokens son firmados con una clave secreta configurable
- En producciÃ³n, la clave secreta es requerida

## ğŸ›ï¸ API de Productos

### Crear producto

```bash
curl -X POST http://localhost:9292/products \
  -H 'Authorization: Bearer tu_access_token' \
  -H 'Content-Type: application/json' \
  -d '{"name":"Pizza"}'
```

### Consultar productos

```bash
curl -X GET http://localhost:9292/products \
  -H 'Authorization: Bearer tu_access_token'
```

## ğŸ” Variables de Entorno

El proyecto requiere las siguientes variables de entorno:

- `JWT_SECRET_KEY`: Clave secreta para firmar los tokens JWT
- `JWT_TOKEN_EXPIRATION`: Tiempo de expiraciÃ³n del token de acceso (en segundos)
- `JWT_REFRESH_TOKEN_EXPIRATION`: Tiempo de expiraciÃ³n del token de refresco (en segundos)
- `JWT_MAX_SESSION_DURATION`: Tiempo mÃ¡ximo de duraciÃ³n de la sesiÃ³n (en segundos)

## ğŸ§  Notas

- El proyecto no usa base de datos: los productos estÃ¡n en memoria
- El endpoint de creaciÃ³n de producto es asÃ­ncrono: el producto aparece a los 5 segundos
- La API devuelve respuestas comprimidas con GZIP si el cliente lo solicita
- Los tokens JWT tienen un tiempo de expiraciÃ³n configurable
- Se implementa un sistema de refresh tokens para renovar tokens expirados
- La sesiÃ³n tiene un tiempo mÃ¡ximo de 30 dÃ­as, independiente de los refreshes
- El router HTTP estÃ¡ implementado usando Sinatra para un mejor manejo de rutas y errores
- Se incluye logging detallado para facilitar el debugging

## ğŸ³ Docker

El proyecto estÃ¡ dockerizado para facilitar su despliegue y ejecuciÃ³n. Se proporcionan dos formas de ejecuciÃ³n:

### Desarrollo

Usa Docker Compose para desarrollo con hot-reload:
```bash
docker compose up
```

### ProducciÃ³n

Usa Docker directamente para producciÃ³n:
```bash
docker build -t ruby-challenge .
docker run -p 9292:9292 ruby-challenge
```

Notas importantes sobre la configuraciÃ³n de Docker:
- Se utiliza Ruby 3.2 con una imagen slim para optimizar el tamaÃ±o
- El contenedor estÃ¡ configurado para escuchar en todas las interfaces (0.0.0.0)
- Se han excluido archivos innecesarios mediante `.dockerignore`
- El puerto 9292 estÃ¡ expuesto para acceder a la aplicaciÃ³n
- En desarrollo, se monta el cÃ³digo como volumen para hot-reload
- Las variables de entorno se configuran en el `docker-compose.yml` para desarrollo

ğŸ§‘ Autores
Ver archivo AUTHORS en la raÃ­z.
